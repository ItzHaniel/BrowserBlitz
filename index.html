<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emotional OS — Calm Mode</title>
  <meta name="description"
    content="A light, inviting Emotional OS for anxious moments: breathe, ground, log, reboot." />

  <style>
    :root {
      /* Light, inviting palette */
      --bg1: #F6FAFF;
      --bg2: #FFF7FB;
      --bg3: #F7FFF9;

      --card: rgba(255, 255, 255, .78);
      --card2: rgba(255, 255, 255, .92);
      --line: rgba(20, 30, 60, .10);

      --text: rgba(18, 25, 40, .92);
      --muted: rgba(18, 25, 40, .65);
      --muted2: rgba(18, 25, 40, .45);

      --accent: #2DD4BF;
      /* teal */
      --accent2: #8B5CF6;
      /* violet */
      --danger: #EF4444;
      --ok: #22C55E;
      --warn: #F59E0B;

      --shadow: 0 20px 55px rgba(15, 20, 40, .12);
      --shadow2: 0 10px 24px rgba(15, 20, 40, .08);

      --radius: 18px;
      --radius2: 26px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      color: var(--text);
      font-family: var(--sans);
      overflow-x: hidden;

      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(45, 212, 191, .18), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(139, 92, 246, .16), transparent 60%),
        radial-gradient(900px 550px at 40% 100%, rgba(34, 197, 94, .12), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2) 40%, var(--bg3));
    }

    /* soft paper grain */
    .grain {
      pointer-events: none;
      position: fixed;
      inset: 0;
      opacity: .06;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: multiply;
    }

    /* floating particles */
    canvas#fx {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 26px 18px 60px;
    }

    header {
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255, 255, 255, .85), rgba(255, 255, 255, .70));
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 0;
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(45, 212, 191, .80), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(139, 92, 246, .75), transparent 55%),
        rgba(255, 255, 255, .75);
      border: 1px solid var(--line);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow2);
    }

    .logo:after {
      content: "";
      position: absolute;
      inset: -40%;
      background: conic-gradient(from 180deg, transparent, rgba(255, 255, 255, .50), transparent);
      animation: spin 10s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .title {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .title h1 {
      margin: 0;
      font-size: 14px;
      letter-spacing: .12em;
      text-transform: uppercase;
      font-family: var(--mono);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .title p {
      margin: 3px 0 0;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .hdr-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      font-family: var(--mono);
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .72);
      color: var(--muted);
      display: flex;
      gap: 8px;
      align-items: center;
      box-shadow: var(--shadow2);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 99px;
      background: var(--ok);
      box-shadow: 0 0 18px rgba(34, 197, 94, .30);
    }

    .btn {
      cursor: pointer;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255, 255, 255, .90), rgba(255, 255, 255, .72));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 13px;
      transition: transform .08s ease, border-color .2s ease, filter .2s ease;
      box-shadow: var(--shadow2);
    }

    .btn:hover {
      border-color: rgba(45, 212, 191, .35);
      filter: brightness(1.01);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn.primary {
      border-color: rgba(45, 212, 191, .35);
      background: linear-gradient(180deg, rgba(45, 212, 191, .22), rgba(255, 255, 255, .80));
    }

    .btn.danger {
      border-color: rgba(239, 68, 68, .35);
      background: linear-gradient(180deg, rgba(239, 68, 68, .16), rgba(255, 255, 255, .82));
    }

    main {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 1.25fr .9fr;
      gap: 14px;
    }

    @media (max-width: 980px) {
      main {
        grid-template-columns: 1fr
      }
    }

    .card {
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255, 255, 255, .88), rgba(255, 255, 255, .72));
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }

    .card-head {
      padding: 14px 16px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(20, 30, 60, .08);
      background: rgba(255, 255, 255, .55);
    }

    .card-head h2 {
      margin: 0;
      font-size: 13px;
      letter-spacing: .12em;
      text-transform: uppercase;
      font-family: var(--mono);
    }

    .card-head p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      max-width: 60ch;
      line-height: 1.35;
    }

    .card-body {
      padding: 14px 16px
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 640px) {
      .grid2 {
        grid-template-columns: 1fr
      }
    }

    .meter {
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(20, 30, 60, .10);
      background: rgba(255, 255, 255, .70);
    }

    .meter .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    .bar {
      height: 10px;
      border-radius: 999px;
      background: rgba(20, 30, 60, .06);
      overflow: hidden;
      margin-top: 10px;
      border: 1px solid rgba(20, 30, 60, .08);
    }

    .bar>i {
      display: block;
      height: 100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(45, 212, 191, .80), rgba(139, 92, 246, .75));
      box-shadow: 0 0 18px rgba(45, 212, 191, .20);
      border-radius: 999px;
      transition: width .25s ease;
    }

    .breath {
      display: flex;
      gap: 14px;
      align-items: center;
      flex-wrap: wrap;
    }

    .orb {
      width: 96px;
      height: 96px;
      border-radius: 999px;
      border: 1px solid rgba(20, 30, 60, .12);
      background: radial-gradient(circle at 30% 25%, rgba(45, 212, 191, .35), transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(139, 92, 246, .25), transparent 60%),
        rgba(255, 255, 255, .70);
      box-shadow: 0 22px 55px rgba(15, 20, 40, .10);
      position: relative;
      flex: 0 0 auto;
      transform: scale(1);
    }

    .orb.pulse {
      animation: breathe 4s ease-in-out infinite;
    }

    @keyframes breathe {
      0% {
        transform: scale(0.92)
      }

      50% {
        transform: scale(1.05)
      }

      100% {
        transform: scale(0.92)
      }
    }

    .orb:after {
      content: "";
      position: absolute;
      inset: -18%;
      border-radius: 999px;
      border: 1px dashed rgba(45, 212, 191, .30);
      opacity: .65;
      animation: spin 14s linear infinite reverse;
    }

    .breath-info {
      min-width: 240px;
      flex: 1 1 auto;
    }

    .big {
      font-family: var(--mono);
      font-size: 26px;
      letter-spacing: .02em;
      margin: 0;
    }

    .sub {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .kbd {
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      border: 1px solid rgba(20, 30, 60, .14);
      background: rgba(255, 255, 255, .70);
      color: var(--muted);
    }

    .steps {
      display: grid;
      gap: 10px;
      margin-top: 12px;
    }

    .step {
      border: 1px solid rgba(20, 30, 60, .10);
      background: rgba(255, 255, 255, .70);
      border-radius: 16px;
      padding: 12px 12px;
    }

    .step .top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    .step .content {
      margin-top: 8px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.35;
    }

    .inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width:640px) {
      .inputs {
        grid-template-columns: 1fr
      }
    }

    textarea {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(20, 30, 60, .14);
      background: rgba(255, 255, 255, .78);
      color: var(--text);
      padding: 10px 10px;
      outline: none;
      font-size: 13px;
      font-family: var(--sans);
      min-height: 92px;
      resize: vertical;
      box-shadow: 0 8px 20px rgba(15, 20, 40, .06);
    }

    textarea::placeholder {
      color: rgba(18, 25, 40, .35)
    }

    .rowwrap {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .log {
      display: grid;
      gap: 10px;
    }

    .log-item {
      border: 1px solid rgba(20, 30, 60, .10);
      background: rgba(255, 255, 255, .70);
      border-radius: 16px;
      padding: 12px 12px;
    }

    .log-item .meta {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .log-item .txt {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text);
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .footer {
      margin-top: 14px;
      color: var(--muted2);
      font-size: 12px;
      text-align: center;
      font-family: var(--mono);
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, .85);
      border: 1px solid rgba(20, 30, 60, .12);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      box-shadow: 0 20px 55px rgba(15, 20, 40, .12);
      backdrop-filter: blur(10px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .help {
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <canvas id="fx"></canvas>
  <div class="grain"></div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>EMOTIONAL OS</h1>
          <p>calm mode • gentle resets • tiny steps</p>
        </div>
      </div>

      <div class="hdr-actions">
        <div class="pill"><span class="dot" id="stateDot"></span><span id="stateText">stable</span></div>
        <button class="btn danger" id="panicBtn">Panic Mode</button>
        <button class="btn primary" id="groundBtn">Ground Me</button>
        <button class="btn" id="resetBtn">Soft Reboot</button>
      </div>
    </header>

    <main>
      <!-- Left: Core -->
      <section class="card">
        <div class="card-head">
          <div>
            <h2>System Dashboard</h2>
            <p>This is a friendly UI for anxious moments. You’re not “failing” — your system is just running hot.</p>
          </div>
          <div class="pill" title="Keyboard shortcuts">
            <span class="kbd">G</span> Ground
            <span class="kbd">P</span> Panic
            <span class="kbd">R</span> Reboot
          </div>
        </div>

        <div class="card-body">
          <div class="grid2">
            <div class="meter">
              <div class="row"><span>CPU (Thoughts)</span><span id="cpuVal">34%</span></div>
              <div class="bar"><i id="cpuBar"></i></div>
            </div>
            <div class="meter">
              <div class="row"><span>RAM (Feelings)</span><span id="ramVal">28%</span></div>
              <div class="bar"><i id="ramBar"></i></div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="breath">
            <div class="orb" id="orb" aria-hidden="true"></div>
            <div class="breath-info">
              <p class="big" id="breathTitle">Idle — you’re okay.</p>
              <p class="sub" id="breathSub">Hit <b>Start Breathing</b> for a 60s timer. Or skip straight to grounding.
              </p>

              <div class="rowwrap">
                <button class="btn primary" id="startBreathBtn">Start Breathing (60s)</button>
                <button class="btn" id="skipBtn">Skip to Grounding</button>
              </div>

              <div class="help">
                Timer: <b id="timerText">00:00</b> • Phase: <b id="phaseText">—</b>
              </div>
            </div>
          </div>

          <div class="steps" style="margin-top:14px">
            <div class="step">
              <div class="top">
                <span>Process: 5-4-3-2-1 Grounding</span>
                <span id="groundStatus">waiting</span>
              </div>
              <div class="content" id="groundContent">
                Name <b>5</b> things you can see, <b>4</b> you can feel, <b>3</b> you can hear, <b>2</b> you can smell,
                <b>1</b> you can taste.
              </div>
            </div>

            <div class="step">
              <div class="top">
                <span>Process: Thought → Driver Update</span>
                <span class="pill" style="padding:6px 10px; border-radius:999px">local-only</span>
              </div>
              <div class="content">
                Write an anxious thought. Then rewrite it as a calmer, more accurate “update.”
                <div class="inputs">
                  <textarea id="thought"
                    placeholder="Anxious thought… (e.g., 'I’m going to mess everything up')"></textarea>
                  <textarea id="reframe"
                    placeholder="Driver update… (e.g., 'I’m stressed, but I can do the next small step')"></textarea>
                </div>
                <div class="rowwrap">
                  <button class="btn primary" id="saveLogBtn">Save to Logs</button>
                  <button class="btn" id="autoReframeBtn">Auto Reframe</button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- Right: Logs -->
      <aside class="card">
        <div class="card-head">
          <div>
            <h2>Emotional Logs</h2>
            <p>Logs stay on your device (localStorage). Little proof you made it through.</p>
          </div>
          <button class="btn" id="clearLogsBtn">Clear</button>
        </div>

        <div class="card-body">
          <div class="log" id="logList"></div>
          <div class="footer">Emotional OS v1 • breathe → ground → continue</div>
        </div>
      </aside>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== helpers =====
    const $ = (id) => document.getElementById(id);

    const toast = (msg) => {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 1400);
    };

    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

    const escapeHtml = (str) => String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");

    // ===== state =====
    const state = {
      mode: "stable",          // stable | panic | grounding | breathing
      cpu: 34,
      ram: 28,

      breathInterval: null,    // setInterval handler (1s ticks)
      breathTotal: 60,         // seconds
      breathRemaining: 0,      // seconds remaining
      phaseName: "—",
      phaseIndex: 0,
      phaseElapsed: 0,         // seconds into current phase

      logs: []
    };

    // ===== persistence =====
    const LS_KEY = "emotional_os_logs_v2";
    function loadLogs() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        state.logs = raw ? JSON.parse(raw) : [];
      } catch { state.logs = []; }
    }
    function saveLogs() {
      localStorage.setItem(LS_KEY, JSON.stringify(state.logs.slice(0, 30)));
    }

    // ===== rendering =====
    function setMode(mode) {
      state.mode = mode;
      const dot = $("stateDot");
      const txt = $("stateText");

      const map = {
        stable: { label: "stable", color: "var(--ok)" },
        panic: { label: "panic", color: "var(--danger)" },
        grounding: { label: "grounding", color: "var(--warn)" },
        breathing: { label: "breathing", color: "var(--accent)" },
      };
      const m = map[mode] || map.stable;
      txt.textContent = m.label;
      dot.style.background = m.color;
      dot.style.boxShadow = "0 0 18px rgba(0,0,0,.06)";
    }

    function renderMeters() {
      $("cpuVal").textContent = `${state.cpu}%`;
      $("ramVal").textContent = `${state.ram}%`;
      $("cpuBar").style.width = `${state.cpu}%`;
      $("ramBar").style.width = `${state.ram}%`;
    }

    function formatMMSS(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function renderTimer() {
      $("timerText").textContent = formatMMSS(state.breathRemaining);
      $("phaseText").textContent = state.phaseName || "—";
    }

    function renderLogs() {
      const list = $("logList");
      list.innerHTML = "";

      if (state.logs.length === 0) {
        const empty = document.createElement("div");
        empty.className = "log-item";
        empty.innerHTML = `
        <div class="meta"><span>no logs yet</span><span>—</span></div>
        <div class="txt">Save a thought + driver update and it’ll show here.</div>
      `;
        list.appendChild(empty);
        return;
      }

      state.logs.slice(0, 12).forEach(item => {
        const el = document.createElement("div");
        el.className = "log-item";
        el.innerHTML = `
        <div class="meta">
          <span>${item.mode.toUpperCase()} • ${item.when}</span>
          <span>CPU ${item.cpu}% • RAM ${item.ram}%</span>
        </div>
        <div class="txt"><b>Thought:</b> ${escapeHtml(item.thought || "—")}\n<b>Update:</b> ${escapeHtml(item.reframe || "—")}</div>
      `;
        list.appendChild(el);
      });
    }

    // ===== breathing (FIXED: real timer) =====
    // We tick once per second and update the displayed MM:SS.
    // Phase schedule: Inhale 4s, Hold 2s, Exhale 6s (repeat)
    const BREATH_PHASES = [
      { name: "Inhale", len: 4 },
      { name: "Hold", len: 2 },
      { name: "Exhale", len: 6 }
    ];

    function stopBreathing() {
      if (state.breathInterval) clearInterval(state.breathInterval);
      state.breathInterval = null;
      $("orb").classList.remove("pulse");
      state.phaseName = "—";
      renderTimer();
    }

    function startBreathing(totalSeconds = 60) {
      stopBreathing();
      setMode("breathing");
      $("orb").classList.add("pulse");

      state.breathTotal = totalSeconds;
      state.breathRemaining = totalSeconds;

      state.phaseIndex = 0;
      state.phaseElapsed = 0;
      state.phaseName = BREATH_PHASES[0].name;

      $("breathTitle").textContent = "Breathing — follow the orb.";
      $("breathSub").textContent = "Inhale 4 • hold 2 • exhale 6. Just ride the loop.";
      renderTimer();

      state.breathInterval = setInterval(() => {
        // update phase
        const phase = BREATH_PHASES[state.phaseIndex];
        state.phaseName = phase.name;

        // cool meters gently each second
        state.cpu = clamp(state.cpu - 1, 6, 100);
        state.ram = clamp(state.ram - 1, 6, 100);
        renderMeters();

        // decrement remaining
        state.breathRemaining = Math.max(0, state.breathRemaining - 1);

        // phase progress
        state.phaseElapsed += 1;
        if (state.phaseElapsed >= phase.len) {
          state.phaseElapsed = 0;
          state.phaseIndex = (state.phaseIndex + 1) % BREATH_PHASES.length;
        }

        // render
        $("breathTitle").textContent = `${state.phaseName} — ${formatMMSS(state.breathRemaining)}`;
        renderTimer();

        if (state.breathRemaining <= 0) {
          stopBreathing();
          startGrounding();
        }
      }, 1000);

      toast("Breathing started.");
    }

    // ===== grounding =====
    let groundingTimeout = null;

    function startGrounding() {
      // cancel any prior grounding chain
      if (groundingTimeout) clearTimeout(groundingTimeout);
      groundingTimeout = null;

      setMode("grounding");
      $("groundStatus").textContent = "running";

      $("breathTitle").textContent = "Grounding — reconnect to now.";
      $("breathSub").textContent = "No perfection needed. Just name what’s true.";

      const prompts = [
        "Name 5 things you can SEE.",
        "Name 4 things you can FEEL (touch/texture/temperature).",
        "Name 3 things you can HEAR.",
        "Name 2 things you can SMELL.",
        "Name 1 thing you can TASTE (or imagine tasting)."
      ];

      let i = 0;
      $("groundContent").innerHTML = `<b>${prompts[i]}</b> (say it out loud or in your head)`;

      const advanceEvery = 12000;
      const advance = () => {
        i++;

        // cool down a bit each step
        state.cpu = clamp(state.cpu - 2, 6, 100);
        state.ram = clamp(state.ram - 2, 6, 100);
        renderMeters();

        if (i >= prompts.length) {
          $("groundStatus").textContent = "done";
          $("groundContent").innerHTML = "✅ Grounding complete. Pick one tiny next step.";
          setMode("stable");
          $("breathTitle").textContent = "Stabilized — you’re okay.";
          $("breathSub").textContent = "If you want, save a quick log. Then continue gently.";
          toast("Grounding complete.");
          return;
        }

        $("groundContent").innerHTML = `<b>${prompts[i]}</b> (say it out loud or in your head)`;
        groundingTimeout = setTimeout(advance, advanceEvery);
      };

      groundingTimeout = setTimeout(advance, advanceEvery);
    }

    // ===== panic + reboot =====
    function panicMode() {
      setMode("panic");
      stopBreathing();

      $("groundStatus").textContent = "waiting";
      $("groundContent").innerHTML = "Panic Mode: we’ll reduce load first. Hit <b>Start Breathing</b> or <b>Ground Me</b>.";

      state.cpu = clamp(state.cpu + 18, 30, 100);
      state.ram = clamp(state.ram + 14, 25, 100);
      renderMeters();

      $("breathTitle").textContent = "Panic Mode — you’re safe.";
      $("breathSub").textContent = "This is a loud alarm, not a prediction. We can soften it.";
      toast("Panic Mode engaged.");
    }

    function softReboot() {
      setMode("stable");
      stopBreathing();
      if (groundingTimeout) clearTimeout(groundingTimeout);
      groundingTimeout = null;

      state.cpu = 34;
      state.ram = 28;
      renderMeters();

      $("breathTitle").textContent = "Idle — you’re okay.";
      $("breathSub").textContent = "Start breathing for 60 seconds, or skip to grounding.";
      $("groundStatus").textContent = "waiting";
      $("groundContent").innerHTML = "Name <b>5</b> you see, <b>4</b> you feel, <b>3</b> you hear, <b>2</b> you smell, <b>1</b> you taste.";
      state.breathRemaining = 0;
      state.phaseName = "—";
      renderTimer();
      toast("Soft reboot complete.");
    }

    // ===== log + reframe =====
    function saveLog() {
      const thought = $("thought").value.trim();
      const reframe = $("reframe").value.trim();
      if (!thought && !reframe) {
        toast("Write something first.");
        return;
      }

      const when = new Date().toLocaleString(undefined, { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' });
      state.logs.unshift({
        when,
        mode: state.mode,
        cpu: state.cpu,
        ram: state.ram,
        thought,
        reframe
      });

      state.logs = state.logs.slice(0, 30);
      saveLogs();
      renderLogs();

      $("thought").value = "";
      $("reframe").value = "";
      toast("Saved to logs.");
    }

    function autoReframe() {
      const t = $("thought").value.trim();
      if (!t) {
        toast("Add an anxious thought.");
        return;
      }
      const templates = [
        "I’m noticing anxiety, not a prophecy. I can do the next small step.",
        "This is discomfort, not danger. I can slow down and continue.",
        "My brain is trying to protect me. I can be kind and choose one action.",
        "Even if it’s messy, progress counts. One minute at a time."
      ];
      $("reframe").value = templates[Math.floor(Math.random() * templates.length)];
      toast("Driver update generated.");
    }

    // ===== events =====
    $("panicBtn").addEventListener("click", panicMode);
    $("groundBtn").addEventListener("click", () => startBreathing(60));
    $("resetBtn").addEventListener("click", softReboot);
    $("startBreathBtn").addEventListener("click", () => startBreathing(60));
    $("skipBtn").addEventListener("click", startGrounding);
    $("saveLogBtn").addEventListener("click", saveLog);
    $("autoReframeBtn").addEventListener("click", autoReframe);
    $("clearLogsBtn").addEventListener("click", () => {
      state.logs = [];
      saveLogs();
      renderLogs();
      toast("Logs cleared.");
    });

    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if (k === "p") panicMode();
      if (k === "g") startBreathing(60);
      if (k === "r") softReboot();
    });

    // ===== boot =====
    function boot() {
      loadLogs();
      renderLogs();
      renderMeters();
      setMode("stable");
      state.breathRemaining = 0;
      state.phaseName = "—";
      renderTimer();
    }
    boot();

    // ===== ambient canvas particles (light) =====
    const c = $("fx");
    const ctx = c.getContext("2d");
    let W, H, dpr;

    function resize() {
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      W = c.width = Math.floor(window.innerWidth * dpr);
      H = c.height = Math.floor(window.innerHeight * dpr);
      c.style.width = window.innerWidth + "px";
      c.style.height = window.innerHeight + "px";
    }
    window.addEventListener("resize", resize);
    resize();

    const particles = Array.from({ length: 60 }, () => ({
      x: Math.random() * W,
      y: Math.random() * H,
      r: (Math.random() * 1.8 + 0.6) * dpr,
      vx: (Math.random() * 0.30 - 0.15) * dpr,
      vy: (Math.random() * 0.30 - 0.15) * dpr,
      a: Math.random() * 0.25 + 0.08
    }));

    function loop() {
      ctx.clearRect(0, 0, W, H);

      // soft vignette glow (light)
      const grd = ctx.createRadialGradient(W * 0.5, H * 0.35, 0, W * 0.5, H * 0.5, Math.max(W, H) * 0.6);
      grd.addColorStop(0, "rgba(45,212,191,0.10)");
      grd.addColorStop(1, "rgba(255,255,255,0)");
      ctx.fillStyle = grd;
      ctx.fillRect(0, 0, W, H);

      for (const p of particles) {
        p.x += p.vx; p.y += p.vy;
        if (p.x < -20) p.x = W + 20;
        if (p.x > W + 20) p.x = -20;
        if (p.y < -20) p.y = H + 20;
        if (p.y > H + 20) p.y = -20;

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(20,30,60,${p.a})`;
        ctx.fill();
      }

      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>

</html>